import processing.helpers as helpers
import pandas as pd
import io


def humanitarian_aid(df: pd.DataFrame):
    rename_data = {
        "Прочее": [
            "Маскировочная сеть",
            "Генератор Бензиновый",
            "Архивное оборудование",
            "Мобильный комплекс",
            "Секундомер",
            "Упряж для служебных собак",
            "Посуда",
        ],
        "БПЛА": [
            "Квадрокоптер",
            "Обнаружитель БПЛА",
            "БПЛА",
        ],
        "Инструменты": ["Триммер"],
        "Строительные материалы и работы": [
            "Плита железобетонная",
            "Стро",
            "стро",
            "Габион",
        ],
        "Транспортные средства/услуги": [
            "Автомобиль",
            "автомобиль",
            "Автмобиль",
            "Автобус",
            "Транспортные услуги",
            "Внедорожный мотоцикл",
        ],
        "Таблички, стенды, плакаты": [
            "Информационный стенд",
            "Плакат",
            "Табличка",
        ],
        "Бытовая техника": [
            "Аккумуляторная батарея",
            "поставка ком",
            "поставка телефонного оборудования",
            "Микроволновка",
            "Ноутбук",
            "Услуги по предоставлению IP телефонии, в рамках которого исполнителем переданы в пользование 6 телеф",
            "Телевизор",
            "Обогреватель",
            "Прожектор",
            "Монитор",
            "Системный блок",
            "Холодильник",
            "Чайник",
            "Кухонное оборудование",
        ],
        "Радиотехника": [
            "Цифровая радиостанция возимая",
            "радио",
            "Радио",
            "Цифровая радиостанция возимая",
            "Рация",
            "Изделие Р-340РП",
            "Тангета",
            "Чехол",
            "Телефон",
        ],
        "Мебель": ["Кровать армейская"],
        "Лек. препараты и мед. изд.": [
            "Лекарственные препараты",
            "Аппарат рентгеновский стоматологический диагностический",
        ],
    }

    df = helpers.prepare(df)
    df = helpers.classification(
        df,
        rename_data,
        "Наименование материальны средств (оказанных услуг)",
        "Что передали",
    )
    df = helpers.null_replacement(
        df,
        {
            "Марка, модель передаваемых материальных средств": "-",
            "Сведения о контрагенте (наименование организации, телефон, сайт)": "-",
        },
    )
    df = helpers.type_conversion(
        df,
        {
            "Кол-во переданного имущества": "Int64",
            "Кол-во не реализованного по заявке имущества": "Int64",
            "№ п/п": "int64",
            "Месяц": "int64",
        },
    )

    # Военные замены: Отправитель заявки, Кому передано имущество (оказаны услуги)
    voen_regex = {
        "Ленинградской области": "ЛО",
        "Войсковая часть №": "В/Ч ",
        "Лекарственные препараты и медицинские изделия": "Лек. препараты и мед. изд.",
        "в/ч": "В/Ч",
        'ФКУ "Объединенное стратегическое командование западного военного округа"': 'ФКУ "ОСК ЗВО"',
        "Некоммерческая организация благотворительный фонд": "НКО БФ",
        "Военный комиссариат": "Военкомат",
        "Пограничное управление Федеральной службы безопасности Российской Федерации": "Пограничное управление ФСБ РФ",
        "по Санкт-Петербургу": "по г. СПБ",
        "по городу Санкт-Петербургу": "по г. СПБ",
    }
    # ОИВ субъекты: ОИВ субъекта РФ (организация), осуществляющая закупку, Сведения о контрагенте (наименование организации, телефон, сайт)
    oiv_regex = {
        "Ленинградской области": "ЛО",
        "Ащминистрация": "Администрация",
        "муниципального района": "МО",
        "Пограничное управление Федеральной службы безопасности Российской Федерации": "Пограничное управление ФСБ РФ",
        "по Санкт-Петербургу": "по г. СПБ",
        "по городу Санкт-Петербургу": "по г. СПБ",
    }

    df = helpers.multi_replace(df, "Отправитель заявки", voen_regex)
    df = helpers.multi_replace(
        df, "Кому передано имущество (оказаны услуги)", voen_regex
    )
    df = helpers.multi_replace(
        df, "ОИВ субъекта РФ (организация), осуществляющая закупку", oiv_regex
    )
    df = helpers.multi_replace(
        df,
        "Сведения о контрагенте (наименование организации, телефон, сайт)",
        oiv_regex,
    )
    df = helpers.uppercase_first_letter(
        df, "Наименование материальны средств (оказанных услуг)"
    )
    df = helpers.uppercase_first_letter(
        df, "ОИВ субъекта РФ (организация), осуществляющая закупку"
    )
    df = helpers.uppercase_first_letter(
        df, "Сведения о контрагенте (наименование организации, телефон, сайт)"
    )
    df["Кол-во не реализованного по заявке имущества"] = (
        df["Потребность по поступившей заявке в/ч"] - df["Кол-во переданного имущества"]
    )

    # Получаем год и месяц
    df["Год"] = df["Дата передачи имущества"].dt.year.astype(str)
    df["Месяц"] = df["Дата передачи имущества"].dt.month.astype(str)

    # Получаем название месяца
    df = helpers.set_month_names(df, "Месяц", "Месяц_назв")

    # Получаем Сколько запросили в еденицах и Сколько передали в еденицах
    df["Сколько запросили в еденицах"] = (
        df["Потребность по поступившей заявке в/ч"].astype(str) + " " + df["Ед. изм."]
    )
    df["Сколько передали в еденицах"] = (
        df["Кол-во переданного имущества"].astype(str) + " " + df["Ед. изм."]
    )
    df["Дата передачи имущества"] = df["Дата передачи имущества"].astype(
        "datetime64[ms]"
    )

    # Дублируем и добавляем все года, все месяца.
    df_d, df_d2, df_d3 = df.copy(), df.copy(), df.copy()

    df_d["Год"] = "Все года"

    df_d2["Месяц_назв"] = "Все месяца"
    df_d2["Месяц"] = 0

    df_d3["Месяц_назв"] = "Все месяца"
    df_d3["Месяц"] = 0
    df_d3["Год"] = "Все года"

    df = pd.concat([df, df_d, df_d2, df_d3], ignore_index=True)
    return df


def procces_df(df: pd.DataFrame, file_name: str):
    if file_name == "ГуманитарнаяПомощьСВО":
        df = humanitarian_aid(df)
    return df
